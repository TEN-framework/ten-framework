#
# Copyright Â© 2025 Agora
# This file is part of TEN Framework, an open source project.
# Licensed under the Apache License, Version 2.0.
# See the LICENSE file for more information.
#
import("//build/feature/ten_package.gni")
import("//build/ten_common/prebuilt/prebuilt.gni")
import("//build/ten_runtime/feature/publish.gni")
import("//build/ten_runtime/options.gni")

config("node_header") {
  include_dirs = [
    "include",
    "include/node",
  ]
}

if (is_win) {
  # Windows uses local prebuilt libraries
  config("node_lib_config") {
    lib_dirs = [ "//third_party/node/lib/win/x64" ]

    if (is_mingw) {
      # MinGW uses libnode.lib directly (same as MSVC import library)
      libs = [ "libnode" ]
    } else {
      # MSVC: Link against libnode.lib (import library for libnode.dll)
      libs = [ "libnode.lib" ]
    }
  }

  # Copy libnode.dll to output directory
  action("copy_node_dll") {
    script = "//.gnfiles/build/scripts/copy_fs_entry.py"

    _source_dll = "//third_party/node/lib/win/x64/libnode.dll"
    _dest_dll = "${root_out_dir}/libnode.dll"

    args = [
      "--source",
      rebase_path(_source_dll),
      "--destination",
      rebase_path(_dest_dll),
    ]

    sources = [ _source_dll ]
    outputs = [ _dest_dll ]
  }

  group("node") {
    public_configs = [
      ":node_header",
      ":node_lib_config",
    ]
    public_deps = [ ":copy_node_dll" ]
  }
} else {
  ten_prebuilt_library("prebuilt_node_shared") {
    name = "node_shared"

    # Version can be easily updated here
    _node_shared_version = "v1.0.15"
    _base_url = "https://github.com/TEN-framework/node_shared/releases/download/${_node_shared_version}"

    if (is_linux) {
      if (target_cpu == "x64") {
        if (is_clang) {
          url = "${_base_url}/node-shared-linux-x64-clang.zip"
        } else {
          url = "${_base_url}/node-shared-linux-x64-gcc.zip"
        }
      } else if (target_cpu == "arm64") {
        if (is_clang) {
          url = "${_base_url}/node-shared-linux-arm64-clang.zip"
        } else {
          url = "${_base_url}/node-shared-linux-arm64-gcc.zip"
        }
      } else {
        assert(false, "Unsupported Linux CPU architecture: ${target_cpu}")
      }
    } else if (is_mac) {
      if (target_cpu == "x64") {
        url = "${_base_url}/node-shared-mac-x64-clang.zip"
      } else if (target_cpu == "arm64") {
        url = "${_base_url}/node-shared-mac-arm64-clang.zip"
      } else {
        assert(false, "Unsupported Mac CPU architecture: ${target_cpu}")
      }
    } else {
      assert(false, "Unsupported platform")
    }

    is_shared_library = true

    libs = [ "node" ]
    lib_version = 127
  }

  group("node") {
    public_configs = [ ":node_header" ]
    public_deps = [ ":prebuilt_node_shared" ]
  }
}
