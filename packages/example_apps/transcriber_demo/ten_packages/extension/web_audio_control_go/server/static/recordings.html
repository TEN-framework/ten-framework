<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recording Playback</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1200px;
            margin: 0 auto;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95em;
        }

        .controls {
            padding: 30px;
            border-bottom: 1px solid #e0e0e0;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            font-size: 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-secondary {
            background: #9e9e9e;
            color: white;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
        }

        .status.recording {
            background: #ffebee;
            color: #c62828;
        }

        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .sessions-list {
            padding: 30px;
        }

        .sessions-list h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .session-item {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .session-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .session-id {
            font-family: monospace;
            font-size: 0.9em;
            color: #666;
        }

        .session-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            color: #666;
            font-size: 0.9em;
        }

        .player-container {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #e0e0e0;
        }

        audio {
            width: 100%;
            margin-bottom: 10px;
        }

        .transcript-box {
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .transcript-box h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .transcript-text {
            line-height: 1.6;
            color: #555;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .nav {
            padding: 20px 30px;
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
        }

        .nav a {
            color: #667eea;
            text-decoration: none;
            margin-right: 20px;
            font-weight: 500;
        }

        .nav a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üéôÔ∏è Recording & Playback</h1>
            <p>Record, transcribe, and playback your audio sessions</p>
        </div>

        <div class="nav">
            <a href="/static/index.html">üè† Home</a>
            <a href="/static/microphone.html">üé§ Microphone</a>
            <a href="/static/recordings.html">üìº Recordings</a>
        </div>

        <div class="controls">
            <div class="button-group">
                <button id="btnStartRecording" class="btn-success">‚ñ∂Ô∏è Start Recording</button>
                <button id="btnStopRecording" class="btn-danger" disabled>‚èπÔ∏è Stop Recording</button>
                <button id="btnRefresh" class="btn-primary">üîÑ Refresh List</button>
            </div>
            <div id="status" class="status" style="display: none;"></div>
        </div>

        <div class="sessions-list">
            <h2>üìö Recording Sessions</h2>
            <div id="sessionsList"></div>
        </div>
    </div>

    <script>
        let isRecording = false;
        let currentSessionId = null;

        const btnStartRecording = document.getElementById('btnStartRecording');
        const btnStopRecording = document.getElementById('btnStopRecording');
        const btnRefresh = document.getElementById('btnRefresh');
        const status = document.getElementById('status');
        const sessionsList = document.getElementById('sessionsList');

        // Start recording
        btnStartRecording.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/start_recording', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.status === 'ok') {
                    isRecording = true;
                    currentSessionId = data.session_id;
                    btnStartRecording.disabled = true;
                    btnStopRecording.disabled = false;
                    showStatus(`Recording started! Session: ${currentSessionId}`, 'recording');
                } else {
                    showStatus(`Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        });

        // Stop recording
        btnStopRecording.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/stop_recording', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.status === 'ok') {
                    isRecording = false;
                    btnStartRecording.disabled = false;
                    btnStopRecording.disabled = true;
                    showStatus(`Recording stopped! Duration: ${(data.duration / 1000).toFixed(2)}s, Segments: ${data.segments}, Words: ${data.words}`, 'success');

                    // Refresh list after 1 second
                    setTimeout(() => loadSessions(), 1000);
                } else {
                    showStatus(`Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        });

        // Refresh list
        btnRefresh.addEventListener('click', () => loadSessions());

        // Load sessions
        async function loadSessions() {
            sessionsList.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading sessions...</p></div>';

            try {
                const response = await fetch('/api/list_sessions');
                const data = await response.json();

                if (data.status === 'ok' && data.sessions) {
                    if (data.sessions.length === 0) {
                        sessionsList.innerHTML = `
                            <div class="empty-state">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                                <h3>No recordings yet</h3>
                                <p>Start recording to create your first session</p>
                            </div>
                        `;
                    } else {
                        sessionsList.innerHTML = data.sessions.map(session => renderSession(session)).join('');
                    }
                } else {
                    sessionsList.innerHTML = '<div class="empty-state"><p>Error loading sessions</p></div>';
                }
            } catch (error) {
                sessionsList.innerHTML = `<div class="empty-state"><p>Error: ${error.message}</p></div>`;
            }
        }

        // Render session item
        function renderSession(session) {
            const startTime = new Date(session.startTime).toLocaleString();
            const duration = session.duration ? (session.duration / 1000).toFixed(2) : 'N/A';
            const audioUrl = `/recordings/${session.sessionId}/audio.wav`;
            const vttUrl = `/recordings/${session.sessionId}/transcript.vtt`;

            return `
                <div class="session-item">
                    <div class="session-header">
                        <div>
                            <div class="session-id">üìù ${session.sessionId}</div>
                        </div>
                        <div>
                            <button class="btn-secondary" onclick="downloadSession('${session.sessionId}')">‚¨áÔ∏è Download</button>
                        </div>
                    </div>
                    <div class="session-meta">
                        <span>‚è∞ ${startTime}</span>
                        <span>‚è±Ô∏è ${duration}s</span>
                        <span>üí¨ ${session.totalSegments || 0} segments</span>
                        <span>üìù ${session.totalWords || 0} words</span>
                    </div>
                    <div class="player-container">
                        <audio controls>
                            <source src="${audioUrl}" type="audio/wav">
                            <track src="${vttUrl}" kind="subtitles" srclang="en" label="Transcript" default>
                            Your browser does not support the audio element.
                        </audio>
                        <small style="color: #999;">üí° Tip: Enable captions/subtitles in the player to see the transcript</small>
                    </div>
                    <div class="transcript-box">
                        <h4>üìÑ Transcript</h4>
                        <div class="transcript-text" id="transcript-${session.sessionId}">Loading...</div>
                    </div>
                </div>
            `;
        }

        // Show status message
        function showStatus(message, type = 'info') {
            status.textContent = message;
            status.className = 'status';
            if (type === 'recording') status.classList.add('recording');
            if (type === 'success') status.classList.add('success');
            status.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }

        // Download session files
        function downloadSession(sessionId) {
            const audioUrl = `/recordings/${sessionId}/audio.wav`;
            const vttUrl = `/recordings/${sessionId}/transcript.vtt`;
            const jsonUrl = `/recordings/${sessionId}/transcript.json`;

            window.open(audioUrl, '_blank');
            setTimeout(() => window.open(vttUrl, '_blank'), 100);
            setTimeout(() => window.open(jsonUrl, '_blank'), 200);
        }

        // Load transcript for each session
        async function loadTranscript(sessionId) {
            try {
                const response = await fetch(`/recordings/${sessionId}/transcript.json`);
                const data = await response.json();
                const transcriptEl = document.getElementById(`transcript-${sessionId}`);
                if (transcriptEl) {
                    transcriptEl.textContent = data.plainText || 'No transcript available';
                }
            } catch (error) {
                const transcriptEl = document.getElementById(`transcript-${sessionId}`);
                if (transcriptEl) {
                    transcriptEl.textContent = 'Error loading transcript';
                }
            }
        }

        // Initial load
        loadSessions();

        // Use MutationObserver to load transcripts when sessions are rendered
        const observer = new MutationObserver(() => {
            document.querySelectorAll('[id^="transcript-"]').forEach(el => {
                const sessionId = el.id.replace('transcript-', '');
                if (el.textContent === 'Loading...') {
                    loadTranscript(sessionId);
                }
            });
        });
        observer.observe(sessionsList, { childList: true, subtree: true });
    </script>
</body>

</html>