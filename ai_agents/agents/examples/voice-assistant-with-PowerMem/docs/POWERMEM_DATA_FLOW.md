# PowerMem 数据流与序列图

本文档通过图表详细说明 PowerMem 在 TEN Framework 中的数据流动。

---

## 系统架构图

```
                            ┌────────────────────────────────────────────┐
                            │              TEN Framework                  │
                            │                                            │
┌──────────┐   音频流        │   ┌─────────┐   ASR结果    ┌────────────┐ │
│  用户    │───────────────▶│   │   STT   │────────────▶│main_control│ │
│ (语音)   │                │   │(Deepgram)│             │            │ │
└──────────┘                │   └─────────┘             │  ┌───────┐ │ │
     ▲                      │                           │  │Memory │ │ │
     │                      │                           │  │ Store │ │ │
     │                      │                           │  └───┬───┘ │ │
     │                      │                           │      │     │ │
     │   音频流              │                           │      ▼     │ │
     │                      │   ┌─────────┐   LLM回复    │  ┌───────┐ │ │
     └──────────────────────│──│   TTS   │◀────────────│──│  LLM  │ │ │
                            │   │(ElevenLabs)│           │  │(OpenAI│ │ │
                            │   └─────────┘             │  └───────┘ │ │
                            │                           └────────────┘ │
                            │                                  │       │
                            └──────────────────────────────────┼───────┘
                                                               │
                                                               ▼
                            ┌────────────────────────────────────────────┐
                            │              PowerMem SDK                   │
                            │  ┌──────────────────────────────────────┐  │
                            │  │            Vector Store               │  │
                            │  │           (OceanBase)                 │  │
                            │  │  ┌────────────────────────────────┐  │  │
                            │  │  │  Semantic Embeddings + Search  │  │  │
                            │  │  └────────────────────────────────┘  │  │
                            │  └──────────────────────────────────────┘  │
                            │  ┌──────────┐  ┌───────────┐              │
                            │  │ LLM      │  │ Embedder  │              │
                            │  │ (Qwen)   │  │ (Qwen)    │              │
                            │  └──────────┘  └───────────┘              │
                            └────────────────────────────────────────────┘
```

---

## 用户加入时序图

```
┌──────┐     ┌──────────┐     ┌────────────┐     ┌─────────┐     ┌─────┐     ┌─────┐
│ 用户 │     │ Agora RTC│     │main_control│     │ PowerMem│     │ LLM │     │ TTS │
└──┬───┘     └────┬─────┘     └─────┬──────┘     └────┬────┘     └──┬──┘     └──┬──┘
   │              │                  │                 │             │           │
   │  加入频道    │                  │                 │             │           │
   │─────────────▶│                  │                 │             │           │
   │              │                  │                 │             │           │
   │              │  on_user_joined  │                 │             │           │
   │              │─────────────────▶│                 │             │           │
   │              │                  │                 │             │           │
   │              │                  │ get_user_profile│             │           │
   │              │                  │────────────────▶│             │           │
   │              │                  │                 │             │           │
   │              │                  │  用户档案/记忆   │             │           │
   │              │                  │◀────────────────│             │           │
   │              │                  │                 │             │           │
   │              │                  │ 生成个性化问候   │             │           │
   │              │                  │────────────────────────────▶│           │
   │              │                  │                 │             │           │
   │              │                  │    问候文本      │             │           │
   │              │                  │◀────────────────────────────│           │
   │              │                  │                 │             │           │
   │              │                  │          合成语音            │           │
   │              │                  │──────────────────────────────────────────▶│
   │              │                  │                 │             │           │
   │  个性化问候语音                 │                 │             │           │
   │◀─────────────────────────────────────────────────────────────────────────────│
   │              │                  │                 │             │           │
```

---

## 对话处理时序图

```
┌──────┐     ┌─────┐     ┌────────────┐     ┌─────────┐     ┌─────┐     ┌─────┐
│ 用户 │     │ STT │     │main_control│     │ PowerMem│     │ LLM │     │ TTS │
└──┬───┘     └──┬──┘     └─────┬──────┘     └────┬────┘     └──┬──┘     └──┬──┘
   │            │              │                 │             │           │
   │  "我上次说过喜欢什么？"     │                 │             │           │
   │───────────▶│              │                 │             │           │
   │            │              │                 │             │           │
   │            │  asr_result  │                 │             │           │
   │            │─────────────▶│                 │             │           │
   │            │              │                 │             │           │
   │            │              │     search      │             │           │
   │            │              │────────────────▶│             │           │
   │            │              │                 │             │           │
   │            │              │   相关记忆      │             │           │
   │            │              │◀────────────────│             │           │
   │            │              │                 │             │           │
   │            │              │ ┌─────────────────────────┐   │           │
   │            │              │ │构建上下文:              │   │           │
   │            │              │ │  - 相关记忆             │   │           │
   │            │              │ │  - 用户问题             │   │           │
   │            │              │ └─────────────────────────┘   │           │
   │            │              │                 │             │           │
   │            │              │   带记忆的查询   │             │           │
   │            │              │────────────────────────────▶│           │
   │            │              │                 │             │           │
   │            │              │     LLM 回复    │             │           │
   │            │              │◀────────────────────────────│           │
   │            │              │                 │             │           │
   │            │              │          合成语音            │           │
   │            │              │──────────────────────────────────────────▶│
   │            │              │                 │             │           │
   │  "你说过喜欢爬山！"        │                 │             │           │
   │◀─────────────────────────────────────────────────────────────────────│
   │            │              │                 │             │           │
```

---

## 记忆保存时序图

```
┌────────────┐     ┌─────────┐     ┌─────────────────────────────────────────┐
│main_control│     │ PowerMem│     │           PowerMem 内部处理               │
└─────┬──────┘     └────┬────┘     │  ┌────────┐  ┌────────┐  ┌────────────┐ │
      │                 │          │  │ LLM    │  │Embedder│  │VectorStore │ │
      │                 │          │  └───┬────┘  └───┬────┘  └─────┬──────┘ │
      │                 │          └──────┼──────────┼────────────┼─────────┘
      │                 │                 │          │            │
      │  触发条件:       │                 │          │            │
      │  - 5轮对话后     │                 │          │            │
      │  - 30秒空闲      │                 │          │            │
      │  - 用户离开      │                 │          │            │
      │                 │                 │          │            │
      │    add()        │                 │          │            │
      │────────────────▶│                 │          │            │
      │                 │                 │          │            │
      │                 │  提取关键信息    │          │            │
      │                 │────────────────▶│          │            │
      │                 │                 │          │            │
      │                 │  关键信息列表    │          │            │
      │                 │◀────────────────│          │            │
      │                 │                 │          │            │
      │                 │     生成向量     │          │            │
      │                 │────────────────────────────▶│            │
      │                 │                 │          │            │
      │                 │     向量表示     │          │            │
      │                 │◀────────────────────────────│            │
      │                 │                 │          │            │
      │                 │              存储到数据库   │            │
      │                 │─────────────────────────────────────────▶│
      │                 │                 │          │            │
      │                 │              存储成功       │            │
      │                 │◀─────────────────────────────────────────│
      │                 │                 │          │            │
      │   保存完成       │                 │          │            │
      │◀────────────────│                 │          │            │
      │                 │                 │          │            │
```

---

## 记忆存储结构

```
                    ┌─────────────────────────────────────────────────────┐
                    │                    OceanBase                        │
                    │               (Vector Database)                     │
                    │                                                     │
                    │  ┌───────────────────────────────────────────────┐  │
                    │  │                memories 表                     │  │
                    │  ├───────────────────────────────────────────────┤  │
                    │  │                                               │  │
                    │  │  ┌─────────────────────────────────────────┐  │  │
                    │  │  │ user_id: "user_001"                     │  │  │
                    │  │  │ agent_id: "voice_assistant"             │  │  │
                    │  │  │ memory: "用户名字叫张三"                  │  │  │
                    │  │  │ embedding: [0.123, 0.456, ...]          │  │  │
                    │  │  │ created_at: 2024-01-15 10:30:00         │  │  │
                    │  │  └─────────────────────────────────────────┘  │  │
                    │  │                                               │  │
                    │  │  ┌─────────────────────────────────────────┐  │  │
                    │  │  │ user_id: "user_001"                     │  │  │
                    │  │  │ agent_id: "voice_assistant"             │  │  │
                    │  │  │ memory: "用户喜欢周末去爬山"              │  │  │
                    │  │  │ embedding: [0.789, 0.012, ...]          │  │  │
                    │  │  │ created_at: 2024-01-15 10:35:00         │  │  │
                    │  │  └─────────────────────────────────────────┘  │  │
                    │  │                                               │  │
                    │  │  ┌─────────────────────────────────────────┐  │  │
                    │  │  │ user_id: "user_001"                     │  │  │
                    │  │  │ agent_id: "voice_assistant"             │  │  │
                    │  │  │ memory: "用户在北京工作"                  │  │  │
                    │  │  │ embedding: [0.345, 0.678, ...]          │  │  │
                    │  │  │ created_at: 2024-01-16 09:15:00         │  │  │
                    │  │  └─────────────────────────────────────────┘  │  │
                    │  │                                               │  │
                    │  └───────────────────────────────────────────────┘  │
                    │                                                     │
                    └─────────────────────────────────────────────────────┘
```

---

## 语义搜索过程

```
     用户查询                      向量化                     相似度匹配

"我之前说过在哪里工作？"          Embedder               ┌─────────────────┐
         │                          │                   │   OceanBase     │
         │                          │                   │                 │
         ▼                          ▼                   │  检索最相似向量  │
┌─────────────────┐        ┌─────────────────┐         │                 │
│ 原始文本        │───────▶│ 查询向量        │─────────▶│  ┌───────────┐  │
│                 │        │ [0.234, 0.567,  │         │  │  向量1    │  │
│ "我之前说过     │        │  0.890, ...]    │         │  │ 相似度:92%│  │
│  在哪里工作？"  │        └─────────────────┘         │  └───────────┘  │
└─────────────────┘                                    │  ┌───────────┐  │
                                                       │  │  向量2    │  │
                                                       │  │ 相似度:87%│  │
                                                       │  └───────────┘  │
                                                       │  ┌───────────┐  │
                                                       │  │  向量3    │  │
                                                       │  │ 相似度:45%│  │
                                                       │  └───────────┘  │
                                                       └────────┬────────┘
                                                                │
                                                                ▼
                                                       ┌─────────────────┐
                                                       │ 返回匹配记忆:   │
                                                       │                 │
                                                       │ "用户在北京工作"│
                                                       │ (相似度: 92%)   │
                                                       │                 │
                                                       │ "用户名字叫张三"│
                                                       │ (相似度: 87%)   │
                                                       └─────────────────┘
```

---

## 状态机：记忆保存触发器

```
                              ┌─────────────────────┐
                              │                     │
                              │     空闲状态        │
                              │    (Idle State)     │
                              │                     │
                              └──────────┬──────────┘
                                         │
                    ┌────────────────────┼────────────────────┐
                    │                    │                    │
                    ▼                    ▼                    ▼
         ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
         │  用户说话       │  │  30秒无活动     │  │  用户离开       │
         │  (User Speaks)  │  │  (30s Timeout)  │  │  (User Leaves)  │
         └────────┬────────┘  └────────┬────────┘  └────────┬────────┘
                  │                    │                    │
                  ▼                    │                    │
         ┌─────────────────┐           │                    │
         │  重置空闲计时器 │           │                    │
         │  turn_id += 1   │           │                    │
         └────────┬────────┘           │                    │
                  │                    │                    │
                  ▼                    │                    │
         ┌─────────────────┐           │                    │
         │ turn_id % 5 == 0?│          │                    │
         └────────┬────────┘           │                    │
                  │                    │                    │
           Yes    │    No              │                    │
        ┌─────────┼─────────┐          │                    │
        │         │         │          │                    │
        ▼         │         ▼          ▼                    ▼
┌───────────────┐ │  ┌─────────────────────────────────────────────┐
│   保存记忆    │ │  │              保存记忆                        │
│ (Save Memory) │ │  │            (Save Memory)                    │
│               │ │  │                                             │
│ 取消空闲计时器 │ │  │  更新 last_memory_update_turn_id            │
└───────────────┘ │  └─────────────────────────────────────────────┘
                  │
                  ▼
         ┌─────────────────┐
         │  返回空闲状态    │
         │  启动30秒计时器  │
         └─────────────────┘
```

---

## 配置关系图

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                              property.json                                    │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │                         main_control 节点                               │  │
│  │                                                                        │  │
│  │   greeting: "Hello! I'm your AI assistant with memory..."              │  │
│  │   agent_id: "voice_assistant_agent"  ◀── 用于隔离不同代理的记忆        │  │
│  │   user_id: "user"                    ◀── 用于隔离不同用户的记忆        │  │
│  │   enable_memorization: true          ◀── 总开关                        │  │
│  │   enable_user_memory: true           ◀── 启用增强档案功能              │  │
│  │   memory_save_interval_turns: 5      ◀── 每5轮保存                     │  │
│  │   memory_idle_timeout_seconds: 30.0  ◀── 30秒空闲保存                  │  │
│  │                                                                        │  │
│  │   ┌──────────────────────────────────────────────────────────────┐    │  │
│  │   │                    powermem_config                            │    │  │
│  │   │                                                               │    │  │
│  │   │   vector_store:                                              │    │  │
│  │   │     provider: "oceanbase"                                    │    │  │
│  │   │     config:                                                  │    │  │
│  │   │       collection_name: ${env:OCEANBASE_COLLECTION}           │    │  │
│  │   │       host: ${env:OCEANBASE_HOST}                            │    │  │
│  │   │       port: ${env:OCEANBASE_PORT}                            │    │  │
│  │   │       ...                                                    │    │  │
│  │   │                                                               │    │  │
│  │   │   llm:                                                       │    │  │
│  │   │     provider: ${env:LLM_PROVIDER}      ◀── 用于提取关键信息   │    │  │
│  │   │     config:                                                  │    │  │
│  │   │       api_key: ${env:LLM_API_KEY}                           │    │  │
│  │   │       model: ${env:LLM_MODEL}                               │    │  │
│  │   │                                                               │    │  │
│  │   │   embedder:                                                  │    │  │
│  │   │     provider: ${env:EMBEDDING_PROVIDER} ◀── 用于生成向量      │    │  │
│  │   │     config:                                                  │    │  │
│  │   │       api_key: ${env:EMBEDDING_API_KEY}                     │    │  │
│  │   │       model: ${env:EMBEDDING_MODEL}                         │    │  │
│  │   │       embedding_dims: ${env:EMBEDDING_DIMS}                 │    │  │
│  │   │                                                               │    │  │
│  │   └──────────────────────────────────────────────────────────────┘    │  │
│  │                                                                        │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 错误处理流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              错误处理策略                                    │
└─────────────────────────────────────────────────────────────────────────────┘

1. 初始化失败
   ┌─────────┐                    ┌───────────────────────────────────────────┐
   │PowerMem │───── 失败 ────────▶│ 记录错误日志，继续运行（无记忆功能）      │
   │ 初始化  │                    │ memory_store = None                       │
   └─────────┘                    └───────────────────────────────────────────┘

2. 问候生成失败
   ┌─────────────┐                ┌───────────────────────────────────────────┐
   │个性化问候   │───── 失败 ────▶│ 使用默认问候语                            │
   │   生成      │                │ config.greeting                           │
   └─────────────┘                └───────────────────────────────────────────┘

3. 记忆检索失败
   ┌─────────────┐                ┌───────────────────────────────────────────┐
   │ 记忆检索   │───── 失败 ────▶│ 正常处理对话（不带记忆上下文）            │
   │            │                │ related_memory = ""                        │
   └─────────────┘                └───────────────────────────────────────────┘

4. 记忆保存失败
   ┌─────────────┐                ┌───────────────────────────────────────────┐
   │ 记忆保存   │───── 失败 ────▶│ 记录错误日志，不影响实时对话              │
   │            │                │ 下次触发时重试                             │
   └─────────────┘                └───────────────────────────────────────────┘

                    ┌─────────────────────────────────────┐
                    │          设计原则                   │
                    │                                     │
                    │  记忆功能是"增强"而非"核心"         │
                    │  任何记忆相关错误不应阻断主流程     │
                    └─────────────────────────────────────┘
```

---

## 性能优化点

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              性能优化策略                                    │
└─────────────────────────────────────────────────────────────────────────────┘

1. 异步保存
   ┌─────────────────────────────────────────────────────────────────────────┐
   │  asyncio.create_task(self._memorize_conversation())                     │
   │                                                                         │
   │  ✅ 不阻塞实时对话                                                      │
   │  ✅ 用户无感知延迟                                                      │
   └─────────────────────────────────────────────────────────────────────────┘

2. 批量保存
   ┌─────────────────────────────────────────────────────────────────────────┐
   │  memory_save_interval_turns: 5   # 每5轮保存一次                        │
   │  memory_idle_timeout_seconds: 30 # 或30秒空闲后保存                     │
   │                                                                         │
   │  ✅ 减少数据库写入频率                                                  │
   │  ✅ 避免重复保存（两种触发器协调）                                      │
   └─────────────────────────────────────────────────────────────────────────┘

3. 超时控制
   ┌─────────────────────────────────────────────────────────────────────────┐
   │  greeting = await asyncio.wait_for(self._greeting_future, timeout=10.0) │
   │                                                                         │
   │  ✅ 问候生成最多等待10秒                                                │
   │  ✅ 超时自动降级到默认问候                                              │
   └─────────────────────────────────────────────────────────────────────────┘

4. 筛选保存
   ┌─────────────────────────────────────────────────────────────────────────┐
   │  # 只保存 user 和 assistant 消息，排除 system                           │
   │  if role in ["user", "assistant"] and isinstance(content, str):        │
   │      conversation_for_memory.append(...)                                │
   │                                                                         │
   │  ✅ 减少无效数据存储                                                    │
   │  ✅ 提高检索精准度                                                      │
   └─────────────────────────────────────────────────────────────────────────┘
```

---

通过这些图表，开发者可以快速理解 PowerMem 在 TEN Framework 中的完整数据流和交互模式。
