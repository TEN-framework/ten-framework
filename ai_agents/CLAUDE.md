# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This is the **TEN Framework AI Agents** repository, a modular platform for building real-time AI agents with voice, video, and multimodal capabilities. The framework uses a graph-based architecture where extensions (ASR, LLM, TTS, RTC, tools) are connected via property.json configurations to create complete AI agent pipelines.

## Development Guidelines

### Do Not Modify Git-Ignored Files

**IMPORTANT:** Do not modify files that are ignored by git - they are automatically generated or managed by build tools.

Common auto-generated files in this repository (see `agents/.gitignore`):
- `manifest-lock.json` - Generated by tman during dependency resolution
- `compile_commands.json` - Generated by build system
- `BUILD.gn` - Generated build configuration
- `.gn`, `.gnfiles` - Generated build system links
- `out/` - Build output directory
- `.ten/` - TEN runtime generated files
- `bin/main`, `bin/worker` - Compiled binaries
- `.release/` - Release packaging output
- `*.log` files - Runtime logs
- `build/` directories - Build artifacts
- `node_modules/` - JavaScript dependencies

When making changes:
- Focus on source files: `*.py`, `*.go`, `*.ts`, `*.tsx`, `manifest.json`, `property.json`, `Taskfile.yml`
- Let build tools regenerate their output files
- If you need to modify build behavior, edit the source configuration (e.g., `Taskfile.yml`, `package.json`) rather than generated files

## Core Architecture

### Extension System

The TEN Framework is built around **extensions** - modular components that provide specific capabilities (ASR, TTS, LLM, tools, etc.). Extensions communicate through a graph-based message passing system.

**Extension Structure:**
- `manifest.json` - Extension metadata, dependencies, and API interface definitions
- `property.json` - Default configuration and parameters (supports `${env:VAR_NAME}` syntax)
- `addon.py` - Registration class using `@register_addon_as_extension` decorator
- `extension.py` - Main extension logic, inheriting from base classes like `AsyncASRBaseExtension`, `AsyncTTSBaseExtension`, etc.
- `tests/` - Standalone test directory with `bin/start` script

**Base Extension Classes:**
- Located in `agents/ten_packages/system/ten_ai_base/interface/ten_ai_base/`
- Common bases: `AsyncASRBaseExtension`, `AsyncTTSBaseExtension`, `LLMBaseExtension`
- API interfaces defined in `agents/ten_packages/system/ten_ai_base/api/*.json`

### Graph-Based Configuration

Agents are configured using **predefined_graphs** in `property.json`:

```json
{
  "ten": {
    "predefined_graphs": [{
      "name": "voice_assistant",
      "auto_start": true,
      "graph": {
        "nodes": [
          {"name": "stt", "addon": "deepgram_asr_python", "property": {...}},
          {"name": "llm", "addon": "openai_llm2_python", "property": {...}},
          {"name": "tts", "addon": "elevenlabs_tts2_python", "property": {...}}
        ],
        "connections": [
          {
            "extension": "main_control",
            "data": [{"name": "asr_result", "source": [{"extension": "stt"}]}]
          }
        ]
      }
    }]
  }
}
```

**Connection Types:**
- `data` - Data messages (asr_result, text, etc.)
- `cmd` - Command messages (on_user_joined, tool_register, etc.)
- `audio_frame` - Audio stream data (pcm_frame)
- `video_frame` - Video stream data

### Repository Structure

```
agents/
├── ten_packages/
│   ├── extension/          # 60+ extensions (ASR, TTS, LLM, tools)
│   │   ├── deepgram_asr_python/
│   │   ├── openai_llm2_python/
│   │   ├── elevenlabs_tts2_python/
│   │   └── ...
│   ├── system/             # Core framework packages
│   │   ├── ten_ai_base/    # Base classes and API interfaces
│   │   ├── ten_runtime_python/
│   │   └── ten_runtime_go/
│   └── addon_loader/       # Language-specific addon loaders
├── examples/               # Complete agent examples
│   ├── voice-assistant/    # Basic voice agent (STT→LLM→TTS)
│   ├── voice-assistant-realtime/  # OpenAI Realtime API
│   ├── voice-assistant-video/     # Vision capabilities
│   └── ...
├── integration_tests/
│   ├── asr_guarder/        # ASR integration testing framework
│   └── tts_guarder/        # TTS integration testing framework
├── scripts/                # Build and package scripts
└── manifest.json           # App-level manifest

server/                     # Go API server
├── main.go                 # HTTP server for agent lifecycle
└── internal/               # Server implementation

playground/                 # Next.js frontend UI
└── src/                    # React components

esp32-client/              # ESP32 hardware client
```

## Development Commands

### Build & Lint

```bash
# Lint all Python extensions
task lint

# Lint specific extension
task lint-extension EXTENSION=deepgram_asr_python

# Format Python code with black
task format

# Check code formatting
task check

```

### Testing

```bash
# Run all tests (server + extensions)
task test

# Test specific extension
task test-extension EXTENSION=agents/ten_packages/extension/elevenlabs_tts_python

# Test extension without reinstalling dependencies
task test-extension-no-install EXTENSION=agents/ten_packages/extension/elevenlabs_tts_python

# Run ASR guarder integration tests
task asr-guarder-test EXTENSION=azure_asr_python CONFIG_DIR=tests/configs

# Run TTS guarder integration tests
task tts-guarder-test EXTENSION=bytedance_tts_duplex CONFIG_DIR=tests/configs
```

**Extension Test Runner:**
Extensions with `tests/` directories use standalone testing:
- Test entry point: `tests/bin/start` (shell script)
- Sets PYTHONPATH to include ten_runtime_python and ten_ai_base interfaces
- Runs pytest or custom test harness
- Requires `.env` file with API keys

### Running Examples

Each example has its own Taskfile.yml:

```bash
# Navigate to example directory
cd agents/examples/voice-assistant

# Install dependencies (frontend, server, tenapp)
task install

# Run everything (API server, frontend, TMAN Designer)
task run

# Run individual components
task run-api-server
task run-frontend
task run-gd-server     # TMAN Designer on port 49483
```

**Ports:**
- Frontend: `http://localhost:3000`
- API Server: `http://localhost:8080`
- TMAN Designer: `http://localhost:49483`

### Server API

The Go server manages agent processes via REST API:

**POST /start** - Start an agent with a graph
```json
{
  "request_id": "uuid",
  "channel_name": "test_channel",
  "user_uid": 176573,
  "graph_name": "voice_assistant",
  "properties": {},
  "timeout": 60
}
```

**POST /stop** - Stop an agent
**POST /ping** - Keep agent alive (if timeout != -1)

## Python Development

### PYTHONPATH Configuration

Extensions require specific PYTHONPATH to import TEN runtime and AI base:

```bash
export PYTHONPATH="./agents/ten_packages/system/ten_runtime_python/lib:./agents/ten_packages/system/ten_runtime_python/interface:./agents/ten_packages/system/ten_ai_base/interface"
```

This is configured in:
- `Taskfile.yml` tasks (lint, test-extension)
- `pyrightconfig.json` (per-example executionEnvironments)
- Extension test scripts (`tests/bin/start`)

### Type Checking

Pyright is configured in `pyrightconfig.json`:
- Mode: `basic`
- Key checks: `reportUnusedCoroutine`, `reportMissingAwait`, `reportUnawaitedAsyncFunctions` = error
- Most type checks disabled to accommodate dynamic TEN runtime APIs
- Separate execution environments per example to resolve imports correctly

## Extension Development Patterns

### Creating a New Extension

1. **Inherit from base class:**
   ```python
   from ten_ai_base.asr import AsyncASRBaseExtension

   class MyASRExtension(AsyncASRBaseExtension):
       async def on_init(self, ten_env: AsyncTenEnv) -> None:
           await super().on_init(ten_env)
           # Load config from property.json
           config_json, _ = await ten_env.get_property_to_json("")
   ```

2. **Register addon:**
   ```python
   from ten_runtime import Addon, register_addon_as_extension

   @register_addon_as_extension("my_asr_python")
   class MyASRExtensionAddon(Addon):
       def on_create_instance(self, ten: TenEnv, addon_name: str, context) -> None:
           ten.on_create_instance_done(MyASRExtension(addon_name), context)
   ```

3. **Define API interface in manifest.json:**
   ```json
   {
     "api": {
       "interface": [
         {"import_uri": "../../system/ten_ai_base/api/asr-interface.json"}
       ]
     }
   }
   ```

### Common Patterns

**Config with Pydantic:**
Extensions typically use Pydantic models for config validation:
```python
from pydantic import BaseModel

class MyConfig(BaseModel):
    api_key: str
    model: str = "default"
```

**Environment Variables:**
Use `${env:VAR_NAME}` or `${env:VAR_NAME|}` (with fallback) in property.json:
```json
{"api_key": "${env:DEEPGRAM_API_KEY}"}
```

**Logging Categories:**
- `LOG_CATEGORY_KEY_POINT` - Important lifecycle events
- `LOG_CATEGORY_VENDOR` - Vendor-specific status/errors

**Message Sending:**
- `await self.send_asr_result(asr_result)`
- `await self.send_asr_error(module_error, vendor_info)`
- `await self.send_asr_finalize_end()`

### Config Management Best Practices

**Separating Authentication vs Passthrough Parameters:**

Extensions should distinguish between two types of parameters:
1. **Non-passthrough params** - Used for authentication/initialization, NOT sent in API request body
2. **Passthrough params** - Sent directly in the API request body/query

**Non-Passthrough Parameters (Top-Level Config Fields):**
- API keys used in Authorization headers
- User IDs for client initialization
- AWS credentials for session creation
- Any parameter used before making the actual API request

**Example Pattern:**

```python
# config.py
class MyTTSConfig(AsyncTTS2HttpConfig):
    """My TTS Config"""

    # Top-level fields for non-passthrough params
    api_key: str = Field(default="", description="API key")
    user_id: str = Field(default="", description="User ID")

    # Passthrough parameters sent in API requests
    params: dict[str, Any] = Field(
        default_factory=dict, description="API request params"
    )

    def update_params(self) -> None:
        """Process params before sending to API"""
        # Add fixed values that should always be sent
        self.params["response_format"] = "pcm"

        # Remove params that shouldn't be sent to API
        # (e.g., sample_rate if it's used elsewhere but not a valid API param)
        if "sample_rate" in self.params:
            del self.params["sample_rate"]

    def validate(self) -> None:
        """Validate required config - check top-level fields"""
        if not self.api_key:
            raise ValueError("API key is required")

    def to_str(self, sensitive_handling: bool = True) -> str:
        """Encrypt sensitive top-level fields for logging"""
        if not sensitive_handling:
            return f"{self}"

        config = copy.deepcopy(self)
        if config.api_key:
            config.api_key = utils.encrypt(config.api_key)

        return f"{config}"
```

```json
// property.json - Top-level fields outside params
{
    "api_key": "${env:MY_TTS_API_KEY|}",
    "user_id": "${env:MY_TTS_USER_ID|}",
    "params": {
        "model": "gpt-4o-mini-tts",
        "voice": "coral",
        "speed": 1.0
    }
}
```

```python
# client.py - Use top-level fields for initialization
class MyTTSClient(AsyncTTS2HttpClient):
    def __init__(self, config: MyTTSConfig, ten_env: AsyncTenEnv):
        super().__init__()
        # Use top-level fields for authentication
        self.client = AsyncClient(
            api_key=config.api_key,
            user_id=config.user_id
        )

    async def get(self, text: str, request_id: str):
        # Spread params into API request - api_key won't be here
        response = await self.client.synthesize(
            text=text,
            **self.config.params
        )
```

**Key Rules:**
1. If a parameter is used for headers, authentication, or client initialization → **Top-level field**
2. If a parameter is sent in the request body → **Keep in params dict**
3. Never manually remove top-level fields from params - they shouldn't be there by design
4. Use `update_params()` to strip params that are computed/derived (like `sample_rate`) before API requests

**Common Examples:**
- `api_key` → Top-level (used in Authorization header)
- `aws_access_key_id`, `aws_secret_access_key` → Top-level (used for boto3 session)
- `model`, `voice`, `speed`, `temperature` → params (sent in API request)
- `sample_rate` → Either top-level (if used by extension) or remove in `update_params()` (if derived)

## TMAN Tool

`tman` is the TEN package manager used for:
- `tman install` - Install extension dependencies from manifest.json
- `tman run start` - Run the tenapp
- `tman designer` - Start TMAN Designer (visual graph editor)

## Integration Tests

**ASR Guarder** (`agents/integration_tests/asr_guarder/`):
- Tests ASR extensions with audio streams
- Validates reconnection, finalization, multi-language, metrics
- Uses pytest fixtures and conftest.py

**TTS Guarder** (`agents/integration_tests/tts_guarder/`):
- Tests TTS extensions with text input
- Validates flush, corner cases, invalid text handling, metrics

Both use template-based manifest generation:
```bash
sed "s/{{extension_name}}/$EXT_NAME/g" manifest-tmpl.json > manifest.json
```

## Environment Configuration

Required `.env` variables depend on extensions used. Common ones:

**RTC:**
- `AGORA_APP_ID`, `AGORA_APP_CERTIFICATE`

**LLM:**
- `OPENAI_API_KEY`, `OPENAI_MODEL`, `OPENAI_API_BASE`
- `AZURE_OPENAI_REALTIME_API_KEY`, `AZURE_OPENAI_REALTIME_BASE_URI`

**ASR:**
- `DEEPGRAM_API_KEY`, `AZURE_ASR_API_KEY`, `AZURE_ASR_REGION`

**TTS:**
- `ELEVENLABS_TTS_KEY`, `AZURE_TTS_KEY`, `AZURE_TTS_REGION`

See `.env.example` for complete list.

## Key Files to Check

When working on:
- **New extension** → Check `agents/ten_packages/extension/<similar_extension>/` for patterns
- **API changes** → Check `agents/ten_packages/system/ten_ai_base/api/*.json`
- **Graph config** → Check `agents/examples/*/tenapp/property.json`
- **Test setup** → Check `agents/ten_packages/extension/*/tests/bin/start`

## Common Issues

**Import errors in extensions:**
- Ensure PYTHONPATH includes ten_runtime_python and ten_ai_base interfaces
- Check pyrightconfig.json executionEnvironments for the example

**Extension not loading:**
- Verify manifest.json dependencies match installed packages
- Check addon.py decorator name matches property.json "addon" field
- Run `tman install` in the tenapp directory

**Test failures:**
- Ensure .env has required API keys
- Check PYTHONPATH in tests/bin/start script
- Verify test configs in tests/configs/ directory