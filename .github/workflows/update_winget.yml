name: Update Winget Package

# This workflow automatically updates the winget package manifest when:
# 1. A new tman Windows binary is released
# 2. This workflow file is modified (for testing purposes)
#
# The workflow submits a PR to microsoft/winget-pkgs repository.

on:
  # Triggered when Windows build workflow completes
  workflow_run:
    workflows:
      - "Tman Windows x64 (Including Designer UI)"
    types:
      - completed
    # Note: We don't filter by branches here because release events run on tags, not branches

  # Triggered when this workflow file or tools/winget directory changes
  # (for testing - runs in DRY RUN mode, won't create actual PR)
  push:
    paths:
      - ".github/workflows/update_winget.yml"
      - "tools/winget/**"

  # Allow manual trigger for testing or emergency updates
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag to update (e.g., 0.11.35)"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write  # Needed to create PR to winget-pkgs

jobs:
  update-winget:
    # Only run on successful workflow completion, manual trigger, or file changes
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.event == 'release')
    runs-on: windows-latest

    steps:
      - name: Debug workflow_run event
        if: github.event_name == 'workflow_run'
        run: |
          Write-Host "üîç Debugging workflow_run event:"
          Write-Host "  Event name: ${{ github.event_name }}"
          Write-Host "  Workflow name: ${{ github.event.workflow_run.name }}"
          Write-Host "  Workflow event: ${{ github.event.workflow_run.event }}"
          Write-Host "  Workflow conclusion: ${{ github.event.workflow_run.conclusion }}"
          Write-Host "  Head branch: ${{ github.event.workflow_run.head_branch }}"
          Write-Host "  Head sha: ${{ github.event.workflow_run.head_sha }}"
          Write-Host ""
          if ("${{ github.event.workflow_run.event }}" -ne "release") {
            Write-Host "‚è≠Ô∏è This workflow was triggered by '${{ github.event.workflow_run.event }}' event, not 'release'."
            Write-Host "   Job will be skipped (only release events trigger Winget updates)."
          } elseif ("${{ github.event.workflow_run.conclusion }}" -ne "success") {
            Write-Host "‚è≠Ô∏è Triggering workflow conclusion was '${{ github.event.workflow_run.conclusion }}', not 'success'."
            Write-Host "   Job will be skipped (only successful workflows trigger Winget updates)."
          } else {
            Write-Host "‚úÖ All conditions met. Proceeding with Winget update..."
          }
        shell: pwsh

      - name: Get version from workflow or input
        id: version
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            # Manual trigger - use input version
            $VERSION = "${{ inputs.version }}"
          } elseif ("${{ github.event_name }}" -eq "push") {
            # File change trigger - use latest release for testing
            $response = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/latest"
            $VERSION = $response.tag_name
            Write-Host "üìã Testing mode: using latest release version"
          } else {
            # Workflow completion - fetch latest release
            $response = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/latest"
            $VERSION = $response.tag_name
          }

          # Output version for next steps
          echo "version=$VERSION" >> $env:GITHUB_OUTPUT
          Write-Host "üì¶ Version to update: $VERSION"
        shell: pwsh

      - name: Wait and verify Windows release asset is uploaded
        id: verify_assets
        uses: actions/github-script@v7
        env:
          VERSION: ${{ steps.version.outputs.version }}
        with:
          script: |
            const version = process.env.VERSION;

            // Expected file for Winget (only Windows x64)
            const expectedFile = 'tman-win-release-x64.zip';

            console.log(`üîç Checking for Windows asset in version: ${version}`);
            console.log(`üìã Expected file: ${expectedFile}`);

            // Try to get the release
            let release;
            try {
              release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: version
              });
            } catch (error) {
              console.error(`‚ùå Failed to get release for tag ${version}:`, error.message);
              throw error;
            }

            // Wait up to 15 minutes for the Windows zip file
            const maxAttempts = 30; // 30 attempts
            const waitSeconds = 30; // 30 seconds between attempts

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              // Get current assets
              const currentRelease = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: version
              });

              const assetNames = currentRelease.data.assets.map(a => a.name);
              const found = assetNames.includes(expectedFile);

              console.log(`‚è≥ Attempt ${attempt}/${maxAttempts}:`);

              if (found) {
                console.log(`   ‚úÖ Found: ${expectedFile}`);
              } else {
                console.log(`   ‚ùå Missing: ${expectedFile}`);
                console.log(`   üìù Available assets:`, assetNames);
              }

              // Check if file is present
              if (found) {
                console.log('');
                console.log('üéâ Windows tman release asset is present!');
                console.log('‚úÖ Ready to update Winget package');

                // Get asset URL for download
                const asset = currentRelease.data.assets.find(a => a.name === expectedFile);

                core.setOutput('all_ready', 'true');
                core.setOutput('asset_url', asset.browser_download_url);
                return;
              }

              // Not ready yet, wait and retry
              if (attempt < maxAttempts) {
                console.log(`   ‚è∞ Waiting ${waitSeconds} seconds before retry...`);
                console.log('');
                await new Promise(resolve => setTimeout(resolve, waitSeconds * 1000));
              }
            }

            // Timeout - file not uploaded
            console.log('');
            console.log('‚ùå Timeout: Windows tman release asset was not uploaded within 15 minutes');
            console.log('‚ö†Ô∏è  Winget package will NOT be updated');
            core.setFailed('Missing release asset after timeout');

      - name: Checkout ten-framework repository
        if: steps.verify_assets.outputs.all_ready == 'true'
        uses: actions/checkout@v4
        with:
          path: ten-framework

      # Required by submit-to-winget.ps1 to fork microsoft/winget-pkgs and create PR
      - name: Install GitHub CLI
        if: steps.verify_assets.outputs.all_ready == 'true'
        run: |
          Write-Host "üì¶ Installing GitHub CLI..."
          winget install --id GitHub.cli --silent --accept-source-agreements --accept-package-agreements

          # Refresh PATH
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")

          # Verify installation
          gh --version
          Write-Host "‚úÖ GitHub CLI installed"
        shell: pwsh

      # Run submit-to-winget.ps1 script
      # This script handles:
      # - Download Windows release asset
      # - Calculate SHA256 checksum
      # - Generate manifest files
      # - Fork and clone winget-pkgs
      # - Create branch and commit
      # - Submit PR to microsoft/winget-pkgs
      - name: Submit to winget-pkgs using PowerShell script
        if: steps.verify_assets.outputs.all_ready == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.WINGET_SUBMIT_TOKEN }}
        run: |
          $VERSION = "${{ steps.version.outputs.version }}"

          # Determine if this is a test run (push event = dry run)
          $IS_DRY_RUN = "${{ github.event_name }}" -eq "push"

          if ($IS_DRY_RUN) {
            Write-Host "üß™ TEST MODE: Running in DRY RUN (will not create PR to winget-pkgs)"
          } else {
            Write-Host "üöÄ PRODUCTION MODE: Will create actual PR to microsoft/winget-pkgs"
          }
          Write-Host "üì¶ Version: $VERSION"
          Write-Host ""

          # Build command with conditional -DryRun flag
          $scriptArgs = @(
            "-Version", $VERSION,
            "-GitHubToken", "${{ secrets.WINGET_SUBMIT_TOKEN }}",
            "-Repository", "${{ github.repository }}"
          )

          if ($IS_DRY_RUN) {
            $scriptArgs += "-DryRun"
          }

          # Run the submission script
          & ten-framework\tools\winget\submit-to-winget.ps1 @scriptArgs

          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Script failed with exit code: $LASTEXITCODE"
            exit $LASTEXITCODE
          }

          Write-Host ""
          if ($IS_DRY_RUN) {
            Write-Host "‚úÖ Dry run completed successfully (no PR created)"
          } else {
            Write-Host "‚úÖ Successfully submitted to winget-pkgs!"
          }
        shell: pwsh

      - name: Create summary
        if: steps.verify_assets.outputs.all_ready == 'true'
        run: |
          $VERSION = "${{ steps.version.outputs.version }}"
          $VERSION_CLEAN = $VERSION -replace '^v', ''
          $IS_DRY_RUN = "${{ github.event_name }}" -eq "push"

          if ($IS_DRY_RUN) {
            $summary = @"
          ## üß™ Winget Package Test (DRY RUN)

          **Version**: $VERSION_CLEAN
          **Mode**: Test mode - No PR was created

          ### ‚úÖ What was tested:

          - ‚úÖ Downloaded Windows release asset
          - ‚úÖ Calculated SHA256 checksum
          - ‚úÖ Generated manifest files from templates
          - ‚úÖ Validated manifest structure

          ### üì¶ Generated Files

          The following manifest files were generated (but not submitted):
          - ``TENFramework.tman.yaml`` (version manifest)
          - ``TENFramework.tman.installer.yaml`` (installer manifest)
          - ``TENFramework.tman.locale.en-US.yaml`` (English)
          - ``TENFramework.tman.locale.zh-CN.yaml`` (ÁÆÄ‰Ωì‰∏≠Êñá)
          - ``TENFramework.tman.locale.zh-TW.yaml`` (ÁπÅÈ´î‰∏≠Êñá)
          - ``TENFramework.tman.locale.ja-JP.yaml`` (Êó•Êú¨Ë™û)
          - ``TENFramework.tman.locale.ko-KR.yaml`` (ÌïúÍµ≠Ïñ¥)

          ### ‚ÑπÔ∏è This was a test run

          To submit for real, trigger this workflow via:
          - **Automatic**: Create a new release (workflow_run trigger)
          - **Manual**: Use workflow_dispatch on GitHub Actions page

          ### üîó Links

          - [Release $VERSION](https://github.com/${{ github.repository }}/releases/tag/$VERSION)
          "@
          } else {
            $summary = @"
          ## ü™ü Winget Package Update Submitted

          **Version**: $VERSION_CLEAN

          ### üì¶ Submitted Files

          The following manifest files were submitted to microsoft/winget-pkgs:
          - ``TENFramework.tman.yaml`` (version manifest)
          - ``TENFramework.tman.installer.yaml`` (installer manifest)
          - ``TENFramework.tman.locale.en-US.yaml`` (English)
          - ``TENFramework.tman.locale.zh-CN.yaml`` (ÁÆÄ‰Ωì‰∏≠Êñá)
          - ``TENFramework.tman.locale.zh-TW.yaml`` (ÁπÅÈ´î‰∏≠Êñá)
          - ``TENFramework.tman.locale.ja-JP.yaml`` (Êó•Êú¨Ë™û)
          - ``TENFramework.tman.locale.ko-KR.yaml`` (ÌïúÍµ≠Ïñ¥)

          ### üì¶ What happens next?

          1. **Automated Validation**: Microsoft's CI will validate the manifest files
          2. **Manual Review**: Microsoft maintainers will review the PR
          3. **Merge**: Once approved, PR will be merged to winget-pkgs
          4. **Available to Users**: After merge, users can install via:

          ````powershell
          winget install TENFramework.tman
          ````

          Or upgrade existing installation:

          ````powershell
          winget upgrade TENFramework.tman
          ````

          ### üîó Links

          - [Release $VERSION](https://github.com/${{ github.repository }}/releases/tag/$VERSION)
          - [Winget-pkgs Repository](https://github.com/microsoft/winget-pkgs)
          - [Asset URL](${{ steps.verify_assets.outputs.asset_url }})

          ### ‚è±Ô∏è Timeline

          Typically, winget PRs are reviewed and merged within 1-3 business days.
          "@
          }

          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
        shell: pwsh

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue_body = `## ‚ö†Ô∏è Winget Package Update Failed

            The automatic Winget package update failed for release \`${{ steps.version.outputs.version }}\`.

            **Workflow**: ${{ github.workflow }}
            **Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ### Possible Issues:

            1. Windows release asset (tman-win-release-x64.zip) was not uploaded within the timeout period
            2. Network issues downloading release asset
            3. Permission issues with WINGET_SUBMIT_TOKEN
            4. Fork of microsoft/winget-pkgs doesn't exist or is out of sync
            5. Manifest validation errors

            ### Manual Update Steps:

            1. Download release asset from: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}
            2. Calculate SHA256 checksum: \`Get-FileHash -Path tman-win-release-x64.zip -Algorithm SHA256\`
            3. Fork microsoft/winget-pkgs repository
            4. Create manifests in \`manifests/t/TENFramework/tman/<version>/\`
            5. Submit PR to microsoft/winget-pkgs

            ### Resources:

            - [Winget Package Submission Guide](https://github.com/microsoft/winget-pkgs/blob/master/AUTHORING_MANIFESTS.md)
            - [Winget Manifest Schema](https://github.com/microsoft/winget-cli/tree/master/schemas/JSON/manifests)

            cc: @${{ github.actor }}
            `;

            console.log(issue_body);
