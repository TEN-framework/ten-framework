name: Coverage Report for rust on Coveralls
on:
  release:
    types: [created]
  pull_request:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - "tools/**"
      - ".vscode/**"
      - ".devcontainer/**"
      - ".github/**"
      - "!.github/workflows/linux_ubuntu2204.yml"
      - "core/src/ten_manager/designer_frontend/**"
      - "**.md"
      - "ai_agents/**"

permissions:
  contents: write

concurrency:
  group: coverage-${{ github.head_ref || github.ref }}-${{ github.sha }}
  cancel-in-progress: false

jobs:
  call-check-pr-status:
    uses: ./.github/workflows/_check_pr_status.yml
  coverage:
    needs: call-check-pr-status
    if: ${{ needs.call-check-pr-status.outputs.should_continue == 'true' }}
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/ten-framework/ten_building_ubuntu2204
    defaults:
      run:
        shell: bash
    steps:
      - name: Debug context
        run: |
          echo "event_name=${{ github.event_name }}"
          echo "event_action=${{ github.event.action }}"
          echo "ref=${{ github.ref }}"
          echo "ref_name=${{ github.ref_name }}"
          echo "ref_type=${{ github.ref_type }}"

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Trust working directory
        run: git config --global --add safe.directory "${GITHUB_WORKSPACE}"

      - name: Initialize and update submodules except portal/
        run: |
          submodules=$(git config --file .gitmodules --get-regexp path | awk '$2 != "portal" { print $2 }')
          git submodule init
          for s in $submodules; do
            git submodule update --init --recursive --depth 1 "$s"
          done

      - name: Setup (nightly for coverage)
        run: rustup default nightly-2025-09-18

      - name: Install cargo-llvm-cov
        run: |
          cargo install cargo-llvm-cov
          cargo llvm-cov --version


      - name: Build ten_utils (required by ten_rust)
        run: |
          export PATH=$(pwd)/core/ten_gn:/root/.cargo/bin:$PATH
          echo $PATH

          # Generate build configuration
          # disable_asan=true - disable ASAN because it conflicts with coverage instrumentation
          # ten_enable_go_lint=false - disable Go lint to avoid installing Go toolchain (coverage test doesn't need it)
          EXTRA_ARGS="is_clang=true log_level=1 enable_sanitizer=false enable_serialized_actions=true ten_rust_enable_gen_cargo_config=false ten_enable_cargo_clean=true ten_enable_go_lint=false ten_enable_rust_incremental_build=false ten_manager_enable_frontend=false ten_enable_integration_tests_prebuilt=false"

          echo "Generating build configuration: $EXTRA_ARGS"
          tgn gen linux x64 debug -- $EXTRA_ARGS

          echo "Building ten_utils..."
          tgn build:core/src/ten_utils linux x64 debug

      - name: Generate Rust coverage
        run: |
          rustup component add llvm-tools-preview

          export RUSTFLAGS="-C instrument-coverage"

          # Ensure ten_rust links against the non-ASAN ten_utils built above
          export TEN_UTILS_LIBRARY_PATH="$(pwd)/out/linux/x64/gen/core/src/ten_utils"

          export PROFRAW_DIR="$(pwd)/out/linux/x64/tests/standalone/ten_rust"
          export LLVM_PROFILE_FILE="$PROFRAW_DIR/rust-%p-%m.profraw"
          if [ ! -d "$PROFRAW_DIR" ]; then
              echo "Creating directory: $PROFRAW_DIR"
              mkdir -p "$PROFRAW_DIR"
          fi

          cd core/src/ten_rust

          cargo llvm-cov \
          --package ten_rust \
          --lcov \
          --output-path "../../../out/linux/x64/tests/standalone/ten_rust/rust-coverage-llvmcov.lcov" \
          --ignore-filename-regex="/.cargo/|/target/"

          cd ../../../

          # Verify coverage file was generated
          if [ -f "out/linux/x64/tests/standalone/ten_rust/rust-coverage-llvmcov.lcov" ]; then
            echo "Coverage file generated successfully"
            ls -lh out/linux/x64/tests/standalone/ten_rust/rust-coverage-llvmcov.lcov
          else
            echo "ERROR: Coverage file not generated!"
            exit 1
          fi

      - name: Debug coverage file content
        run: |
          COV_FILE="out/linux/x64/tests/standalone/ten_rust/rust-coverage-llvmcov.lcov"
          echo "=== Detailed coverage file analysis ==="

          if [ -f "$COV_FILE" ]; then
              echo "✅ File exists, size: $(wc -c < "$COV_FILE") bytes"
              echo "📊 Line count: $(wc -l < "$COV_FILE")"

              echo "=== File content (first 30 lines) ==="
              head -30 "$COV_FILE"

              echo "=== LCOV structure analysis ==="
              echo "Test names (TN): $(grep -c "^TN:" "$COV_FILE" || echo 0)"
              echo "Source files (SF): $(grep -c "^SF:" "$COV_FILE" || echo 0)"
              echo "Lines found (LF): $(grep "^LF:" "$COV_FILE" | awk '{sum += $2} END {print sum+0}')"
              echo "Lines hit (LH): $(grep "^LH:" "$COV_FILE" | awk '{sum += $2} END {print sum+0}')"
              echo "End of record markers: $(grep -c "^end_of_record" "$COV_FILE" || echo 0)"

              # 列出所有被覆盖的源文件
              echo "=== Source files in coverage ==="
              grep "^SF:" "$COV_FILE" | head -10
          else
              echo "❌ Coverage file not found"
              exit 1
          fi

      - name: Upload coverage to Coveralls
        uses: coverallsapp/github-action@v2
        env:
          COVERALLS_REPO_TOKEN: ${{ secrets.TEN_COVERALLS_REPO_TOKEN }}
        with:
          file: out/linux/x64/tests/standalone/ten_rust/rust-coverage-llvmcov.lcov
          base-path: .
          format: lcov
          coveralls-endpoint: https://coveralls.io
          fail-on-error: true
          debug: true